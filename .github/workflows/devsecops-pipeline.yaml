name: DevSecOps Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    # 03:00 WIB (UTC+7) = 20:00 UTC
    - cron: "0 20 * * *"
  workflow_dispatch:

concurrency:
  group: devsecops-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  packages: write

env:
  NODE_VERSION: 20
  REGISTRY: ${{ secrets.REGISTRY }}                 # e.g. docker.io
  IMAGE_NAME: ${{ secrets.IMAGE_NAME }}             # e.g. my-app
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

defaults:
  run:
    shell: bash

jobs:
  # =================================================================
  # GROUP 1: PARALLEL JOBS (jalan bersamaan)
  # =================================================================

  test_and_sast:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    name: ðŸ§± Test & SAST

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm test

      - name: Coverage (NYC + Mocha)
        run: |
          npx cross-env NODE_OPTIONS=--experimental-vm-modules npm run precover
          npx cross-env NODE_OPTIONS=--experimental-vm-modules npm run cover

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/

      - name: SonarCloud Scan (SAST)
        uses: SonarSource/sonarcloud-github-action@4006f663ecaf1f8093e8e4abb9227f6041f52216 # v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=devsecopsganodejs
            -Dsonar.projectKey=devsecopsganodejs
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  security_audit:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    name: ðŸ§© SCA & FS Audit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Dependencies
        run: npm ci

      # --- Snyk SCA ---
      - name: Snyk Scan
        uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04 # 1.0.0
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=low --json-file-output=snyk-report.json

      - name: Enforce Snyk Policy (Fail on High/Critical)
        run: |
          if [ ! -f snyk-report.json ]; then
            echo "â›” Missing snyk-report.json (Snyk may have failed to generate report)."
            exit 2
          fi

          jq -e '
            ([.. | objects | select(has("severity")) | .severity]
             | map(select(.=="high" or .=="critical"))
             | length) == 0
          ' snyk-report.json >/dev/null \
          || { echo "â›” Security Gate Failed: Found High/Critical vulnerabilities."; exit 1; }

          echo "âœ… Snyk gate passed."

      # --- Trivy FS ---
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          output: trivy-report.txt

      - name: Upload Security Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: |
            snyk-report.json
            trivy-report.txt

  # =================================================================
  # IMAGE SAST/SCA (Container): BUILD LOCAL -> TRIVY SARIF -> UPLOAD
  # (Letakkan "setelah build lokal")
  # Skip saat schedule untuk menghindari build harian otomatis.
  # =================================================================
  image_scan_trivy_sarif:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: ðŸ§ª Build Local + Trivy Image SARIF

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local, for scanning)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          vuln-type: os,library
          # Gate: fail job if CRITICAL/HIGH exists (matching 'severity')
          exit-code: 1

      - name: Upload Trivy scan results to GitHub Security tab
        # Upload SARIF sering dibatasi untuk PR dari fork (token permissions).
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-image

      - name: Upload Trivy SARIF as artifact (fallback)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: trivy-sarif
          path: trivy-results.sarif

  # =================================================================
  # GROUP 2: BUILD & PUSH (PODMAN) - skip saat schedule
  # =================================================================
  podman_build_push:
    if: github.event_name != 'schedule'
    needs: [test_and_sast, security_audit, image_scan_trivy_sarif]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: ðŸ“¦ Build & Push Image (Podman)
    outputs:
      sha_tag: ${{ steps.meta.outputs.sha_tag }}
      image_repo: ${{ steps.meta.outputs.image_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - id: meta
        name: Prepare Image Metadata
        run: |
          echo "sha_tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "image_repo=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}" >> "$GITHUB_OUTPUT"

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Registry Login (Podman non-TTY fix)
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
          podman login "${{ env.REGISTRY }}" -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Image
        run: |
          podman build \
            -t "${{ steps.meta.outputs.image_repo }}:${{ steps.meta.outputs.sha_tag }}" \
            -t "${{ steps.meta.outputs.image_repo }}:latest" .

      - name: Push Images
        run: |
          podman push "${{ steps.meta.outputs.image_repo }}:${{ steps.meta.outputs.sha_tag }}"
          podman push "${{ steps.meta.outputs.image_repo }}:latest"

  # =================================================================
  # GROUP 2: SIGNING - skip saat schedule
  # =================================================================
  cosign_sign:
    if: github.event_name != 'schedule'
    needs: [podman_build_push]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: ðŸ” Cosign Signing

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: "v2.4.1"

      - name: DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sign & Export Signature
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          FULL_IMAGE: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          SHA_TAG: ${{ needs.podman_build_push.outputs.sha_tag }}
        run: |
          set -euo pipefail
          echo "$COSIGN_PRIVATE_KEY" > cosign.key
          cosign version

          cosign sign --key cosign.key -y "$FULL_IMAGE:$SHA_TAG"
          cosign download signature "$FULL_IMAGE:$SHA_TAG" --output-file cosign.sig

      - name: Upload Cosign Signature
        uses: actions/upload-artifact@v5
        with:
          name: cosign-signature
          path: cosign.sig

  # =================================================================
  # GROUP 3: DAST (Smart ZAP)
  # - CI (push/PR): baseline after signing
  # - schedule: full scan without build/push/sign
  # =================================================================
  dast_zap_ci:
    if: github.event_name != 'schedule'
    needs: [cosign_sign]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: ðŸŽ¯ ZAP Baseline (CI)
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Start App
        run: |
          nohup npm start &>/dev/null &
          disown || true
          echo "Waiting app on :3000..."
          sleep 10

      - name: Run ZAP Baseline via Docker
        run: |
          chmod 777 .
          docker run -v "$(pwd)":/zap/wrk/:rw \
            --network="host" \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:3000 \
            -r report_html.html \
            -J report_json.json || true

      - name: Upload ZAP Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: zap-report-ci
          path: |
            report_html.html
            report_json.json

  dast_zap_nightly:
    if: github.event_name == 'schedule'
    needs: [test_and_sast, security_audit]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    name: ðŸŽ¯ ZAP Full (Nightly)
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Start App
        run: |
          nohup npm start &>/dev/null &
          disown || true
          echo "Waiting app on :3000..."
          sleep 10

      - name: Run ZAP Full via Docker
        run: |
          chmod 777 .
          docker run -v "$(pwd)":/zap/wrk/:rw \
            --network="host" \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t http://localhost:3000 \
            -r report_html.html \
            -J report_json.json \
            -a || true

      - name: Upload ZAP Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: zap-report-nightly
          path: |
            report_html.html
            report_json.json

  # =================================================================
  # SUMMARY (needs harus eksplisit supaya outputs bisa dibaca)
  # =================================================================
  summary:
    needs:
      - test_and_sast
      - security_audit
      - image_scan_trivy_sarif
      - podman_build_push
      - cosign_sign
      - dast_zap_ci
      - dast_zap_nightly
    if: always()
    runs-on: ubuntu-latest
    name: ðŸ§¾ DevSecOps Summary

    steps:
      - name: Final Summary
        run: |
          echo "## DevSecOps Pipeline â€” Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Unit Tests + Coverage + SonarCloud SAST" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Snyk SCA gate + Trivy FS (artifact: security-reports)" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "- âœ… Trivy Image SARIF (Security tab + artifact: trivy-sarif)" >> "$GITHUB_STEP_SUMMARY"
            echo "- âœ… Build & Push â†’ ${{ needs.podman_build_push.outputs.image_repo }}:${{ needs.podman_build_push.outputs.sha_tag }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- âœ… Cosign Signature exported (artifact: cosign-signature)" >> "$GITHUB_STEP_SUMMARY"
            echo "- âœ… ZAP Baseline â†’ artifact: zap-report-ci" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- ðŸ•’ Nightly run (no build/push/sign, no image SARIF build)" >> "$GITHUB_STEP_SUMMARY"
            echo "- âœ… ZAP Full Scan â†’ artifact: zap-report-nightly" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Pipeline finished (DAST is allowed to fail by design)." >> "$GITHUB_STEP_SUMMARY"
