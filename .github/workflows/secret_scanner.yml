name: Secret Scanning â€” TruffleHog ðŸ•µï¸

on:
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  secret_scanning:
    name: ðŸ” Secret Leak Detection (TruffleHog)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ›’ Checkout full repo history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§© Run TruffleHog scan
        uses: trufflesecurity/trufflehog@f1ccb3979760ac13b571361ec2a2c401b9b864c6
        with:
          scan: git
          extra_args: >
            --only-verified
            --fail
            --json
            --since-commit ${{ github.event.pull_request.base.sha }}
            --branch ${{ github.head_ref || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Upload Scan Report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: trufflehog-report
          path: trufflehog_results.json

      - name: ðŸª¶ Create Issue if Secrets Found
        if: failure()
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd
        with:
          title: "ðŸš¨ Secret Leak Detected (TruffleHog)"
          content-filepath: trufflehog_results.json
          labels: |
            security
            secrets
            high-risk
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§¾ Summary
        if: always()
        run: |
          echo "## ðŸ•µï¸ Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Tool: TruffleHog (commit-pinned)" >> $GITHUB_STEP_SUMMARY
          echo "- Report: trufflehog_results.json" >> $GITHUB_STEP_SUMMARY
