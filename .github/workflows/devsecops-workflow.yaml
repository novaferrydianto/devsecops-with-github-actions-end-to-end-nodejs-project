name: Build, Test, and Secure Node.js App ðŸ›¡ï¸

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 3 * * 0' # Weekly Sunday auto security scan

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build_and_sast:
    name: ðŸ§± Build, Unit Tests, and SAST (SonarCloud)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: âš¡ Cache Node Modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§° Verify Dev Dependencies (Self-Healing)
        run: |
          echo "ðŸ” Checking essential dev dependencies..."
          npm ls source-map-support || npm install --save-dev source-map-support
          npm ls cross-env || npm install --save-dev cross-env
          npm ls nyc || npm install --save-dev nyc
          echo "âœ… Dev dependencies verified."

      - name: ðŸ§ª Run Unit Tests
        run: npm test

      - name: ðŸ“Š Run Coverage (NYC + Mocha)
        run: |
          npx cross-env NODE_OPTIONS=--experimental-vm-modules npm run precover
          npx cross-env NODE_OPTIONS=--experimental-vm-modules npm run cover

      - name: ðŸ“¤ Upload Coverage Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: âœ… Coverage Summary
        run: |
          npx nyc report --reporter=text-summary > coverage-summary.txt
          cat coverage-summary.txt

      - name: ðŸ’¬ Generate Coverage Summary for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ§ª **Test & Coverage Report**" > coverage-comment.md
          echo "" >> coverage-comment.md
          if grep -q "100%" coverage-summary.txt; then
            echo "âœ… All tests passed with **100% coverage!**" >> coverage-comment.md
          else
            echo "âš ï¸ Partial coverage detected â€” please review!" >> coverage-comment.md
          fi
          echo "" >> coverage-comment.md
          echo "ðŸ“ˆ \`$(grep 'Statements' coverage-summary.txt | sed 's/^.*: //')\`" >> coverage-comment.md
          echo "ðŸ“Š See full report: \`coverage/lcov.info\`" >> coverage-comment.md
          echo "" >> coverage-comment.md
          echo "ðŸ§¾ Generated automatically by CI ðŸ§ " >> coverage-comment.md

      - name: ðŸ—¨ï¸ Comment PR with Coverage Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ðŸ§ª Test & Coverage Report
          path: coverage-comment.md

      - name: ðŸš€ SonarCloud Scan (SAST)
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=devsecopsganodejs
            -Dsonar.projectKey=devsecopsganodejs
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.testExecutionReportPaths=xunit.xml
            -Dsonar.sourceEncoding=UTF-8

      - name: ðŸ§¾ Job Summary â€” Test & Coverage
        if: always()
        run: |
          echo "## ðŸ§ª Test & Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat coverage-summary.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full report: [coverage/lcov.info](./coverage/lcov.info)" >> $GITHUB_STEP_SUMMARY

  sca_snyk:
    name: ðŸ§© Software Composition Analysis (SCA) - Snyk
    runs-on: ubuntu-latest
    needs: build_and_sast

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ•µï¸ Run Snyk Vulnerability Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: ðŸ§© Monitor project in Snyk Dashboard
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

      - name: ðŸ“¤ Upload Snyk Report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: snyk-report.json

      - name: ðŸ’¬ Post Snyk Summary to PR
        if: github.event_name == 'pull_request'
        run: |
          if grep -q '"severity":"critical"' snyk-report.json; then
            SUMMARY="âš ï¸ **Critical vulnerabilities found!**"
          elif grep -q '"severity":"high"' snyk-report.json; then
            SUMMARY="âš ï¸ **High vulnerabilities found!**"
          else
            SUMMARY="âœ… **No high or critical vulnerabilities found.**"
          fi
          echo "${SUMMARY}" > snyk-summary.md
          echo "" >> snyk-summary.md
          echo "ðŸ“Š See full report artifact: \`snyk-report.json\`" >> snyk-summary.md
          echo "ðŸ”— [View project in Snyk Dashboard](https://app.snyk.io)" >> snyk-summary.md

      - name: ðŸ—¨ï¸ Comment PR with Snyk Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ðŸ›¡ï¸ Snyk Security Scan
          path: snyk-summary.md

      - name: ðŸ§¾ Job Summary â€” Snyk Security
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Snyk Security Summary" >> $GITHUB_STEP_SUMMARY
          if grep -q '"severity":"critical"' snyk-report.json; then
            echo "âš ï¸ **Critical vulnerabilities found!**" >> $GITHUB_STEP_SUMMARY
          elif grep -q '"severity":"high"' snyk-report.json; then
            echo "âš ï¸ **High severity vulnerabilities found!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No high or critical vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ“„ [Full report](./snyk-report.json)" >> $GITHUB_STEP_SUMMARY

  optional_trivy:
    name: ðŸ§  Container & IaC Security (Trivy)
    runs-on: ubuntu-latest
    needs: sca_snyk
    continue-on-error: true

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Run Trivy File System Scan
        uses: aquasecurity/trivy-action@0.18.0
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          output: 'trivy-report.txt'

      - name: ðŸ“¤ Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

      - name: ðŸ§¾ Job Summary â€” Trivy Scan
        if: always()
        run: |
          echo "## ðŸ§  Trivy IaC & Container Scan" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -n 20 trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ [Full report](./trivy-report.txt)" >> $GITHUB_STEP_SUMMARY

  dast_zap:
    name: ðŸŽ¯ Dynamic App Security Testing (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: sca_snyk
    continue-on-error: true

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸš€ Start Application in Background
        run: |
          nohup npm start &
          sleep 10

      - name: ðŸ§ª Run OWASP ZAP Full Scan (DAST)
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'http://localhost:3000'
          cmd_options: '-a'
          report_name: zap-report.html
          output_dir: reports
          allow_issue_writing: true
          fail_action: false

      - name: ðŸ“¤ Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-scan
          path: reports/zap-report.html

      - name: ðŸ§¾ Job Summary â€” ZAP DAST
        if: always()
        run: |
          echo "## ðŸŽ¯ OWASP ZAP DAST Summary" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ [ZAP HTML Report](./reports/zap-report.html)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Automated dynamic web app security test complete." >> $GITHUB_STEP_SUMMARY

  summary:
    name: ðŸ§¾ Generate DevSecOps Summary
    runs-on: ubuntu-latest
    needs: [build_and_sast, sca_snyk, optional_trivy, dast_zap]

    steps:
      - name: ðŸ“œ Generate Final DevSecOps Markdown Summary
        run: |
          echo "# ðŸ§¾ DevSecOps Pipeline Summary" > devsecops-summary.md
          echo "" >> devsecops-summary.md
          echo "âœ… **All security stages completed successfully!**" >> devsecops-summary.md
          echo "" >> devsecops-summary.md
          echo "| Stage | Status | Artifact |" >> devsecops-summary.md
          echo "|-------|--------|-----------|" >> devsecops-summary.md
          echo "| ðŸ§ª Tests & Coverage | âœ… Passed | coverage/lcov.info |" >> devsecops-summary.md
          echo "| ðŸ›¡ï¸ Snyk SCA | âœ… Completed | snyk-report.json |" >> devsecops-summary.md
          echo "| ðŸ§  Trivy Scan | âœ… Completed | trivy-report.txt |" >> devsecops-summary.md
          echo "| ðŸŽ¯ ZAP DAST | âœ… Completed | reports/zap-report.html |" >> devsecops-summary.md
          echo "" >> devsecops-summary.md
          echo "âœ¨ Generated on: $(date -u)" >> devsecops-summary.md
          echo "ðŸ‘· Runner: $RUNNER_NAME ($RUNNER_OS)" >> devsecops-summary.md
          echo "" >> devsecops-summary.md
          echo "---" >> devsecops-summary.md
          echo "ðŸ§  *Generated automatically by DevSecOps CI Pipeline â€” $(date -u)*" >> devsecops-summary.md

      - name: ðŸ“¤ Upload DevSecOps Markdown Summary
        uses: actions/upload-artifact@v4
        with:
          name: devsecops-summary
          path: devsecops-summary.md

      - name: ðŸ§¾ Append Final Summary to GitHub Checks
        run: |
          echo "## ðŸ§¾ DevSecOps Summary (Full Report)" >> $GITHUB_STEP_SUMMARY
          cat devsecops-summary.md >> $GITHUB_STEP_SUMMARY
