name: ðŸ•µï¸ Secret Scanning (TruffleHog)

permissions:
  contents: read
  issues: write

on:
  pull_request:
    branches: [master]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**/README*'

jobs:
  secret_scanning:
    name: ðŸ§© Secret Scanning (TruffleHog)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ” Run TruffleHog Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@f1ccb3979760ac13b571361ec2a2c401b9b864c6 # main
        with:
          scan: git
          extra_args: --json --no-update > trufflehog-report.json || true

      - name: ðŸ“Š Parse TruffleHog Results
        if: always()
        run: |
          if [ -f trufflehog-report.json ]; then
            FOUND=$(grep -c '"SourceMetadata"' trufflehog-report.json || true)
            echo "SECRET_COUNT=$FOUND" >> $GITHUB_ENV
            echo "ðŸ” Found $FOUND potential secrets."
          else
            echo "SECRET_COUNT=0" >> $GITHUB_ENV
            echo "âœ… No secrets found."
          fi

      - name: ðŸª¶ Create Issue if Secrets Found
        if: env.SECRET_COUNT != '0'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸš¨ Secret Scanning Alert â€” TruffleHog Findings"
          content-filepath: trufflehog-report.json
          labels: |
            security
            trufflehog
            high-risk
          template: "security-scan-failure.yml"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload TruffleHog Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json